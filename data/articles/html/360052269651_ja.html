<p dir="auto"><span class="wysiwyg-font-size-large"><strong>注: この記事では、ジョブに含まれる、メイン コンテナ用の "環境のスピンアップ" ステップの観点から Docker Executor のキャッシュの働きについて説明します。 本記事の内容は、<a href="https://circleci.com/docs/ja/2.0/building-docker-images/" target="_self">リモート Docker 環境</a>の機能である <a href="https://circleci.com/docs/ja/2.0/docker-layer-caching/" target="_self">Docker レイヤー キャッシュ</a>には<em>適用できません</em>。</strong></span></p>
<p dir="auto">Docker コンテナのスピンアップからジョブの実行までに要する時間は、複数の要因により変わることがあります。要因としては、イメージのサイズのほか、レイヤーの一部または全部が基盤となる Docker ホスト マシンに既にキャッシュされているかどうかも影響します。</p>
<p dir="auto">一般的に、<a href="https://circleci.com/docs/ja/2.0/circleci-images/" target="_self">CircleCI コンビニエンス イメージ</a>のような広く利用されているイメージほど、多くのレイヤーがキャッシュでヒットする可能性が高くなります。 よく利用される CircleCI イメージの大部分では同じベース イメージが使用されているので、<em>基本レイヤー</em>のほとんどもイメージ間で違いがないために、キャッシュがヒットする<em>確率</em>が高くなっているわけです。</p>
<p dir="auto">環境のスピンアップは新しいジョブごとに必要です。新規ジョブが同じワークフロー内にある場合でも、ジョブの再実行や 2 回目以降の実行の場合でも、セキュリティ上の理由から、コンテナを再利用することはありません。 ジョブが終了すると、コンテナは破棄されます。 同じワークフロー内にある場合であっても、ジョブが同じ Docker ホスト マシンで実行されることは保証できません。また、異なる Docker ホスト マシンで実行される可能性があるため、キャッシュの状態も変わる場合があります。</p>
<p dir="auto">いかなる場合でも、キャッシュのヒットは保証されるものではなく、ヒットすればラッキーな景品のようなものと言えるでしょう。 そのため、すべてのジョブでキャッシュがまったくヒットしないケースも想定しておいてください。</p>
<p dir="auto"><span>Docker レイヤー キャッシュのメリットは、リモート Docker 環境を使用して </span><em>CircleCI</em><span> でイメージを</span><em>ビルド</em><span>する場合にのみ得られます。ジョブの</span><em>実行</em><span>に使用される実際の Docker コンテナのスピンアップ時間には影響しません。 Docker レイヤー キャッシュの詳細については、</span><a href="https://circleci.com/docs/ja/2.0/docker-layer-caching/" rel="noreferrer">こちら</a><span>を参照してください。</span></p>
<p dir="auto">要約すると、キャッシュのヒット率は設定や構成で制御することはできません。<a href="https://circleci.com/docs/ja/2.0/circleci-images/" target="_self">CircleCI コンビニエンス イメージ</a>など、広く利用されているイメージを選択すれば、"環境のスピンアップ" ステップでレイヤーがキャッシュでヒットする可能性が高まるでしょう。</p>